<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sohoki.backoffice.sts.res.mapper.TimeInfoManageMapper">
    <!--  수정 신규 테이블에 맞게 변경 회의실만 -->
    <select id="selectSTimeInfoBarList" resultType="lmap">
      <![CDATA[
        SELECT a.TIME_SEQ, a.SWC_TIME, 
               CASE WHEN a.SWC_RESDAY != CONVERT(VARCHAR(8), GETDATE(), 112) THEN RES_SEQ
        	        WHEN a.SWC_TIME > REPLACE(SUBSTRING(CONVERT(VARCHAR(12), GETDATE(), 114), 1,5), ':','')  THEN RES_SEQ
        	        WHEN a.RES_SEQ > 0 THEN a.RES_SEQ
               ELSE -1
               END AS RES_SEQ,  a.APPRIVAL, a.USE_YN, a.ITEM_ID, a.SWC_RESDAY
	    FROM TB_SWCTIME a, TB_MEETING_ROOM b 
	    WHERE a.SWC_RESDAY = #{params.swcResday} AND a.ITEM_ID = #{params.itemId} 
	          AND a.SWC_TIME BETWEEN (SELECT START_TIME FROM TB_SWCINFO) and (SELECT END_TIME FROM TB_SWCINFO)
	          AND a.ITEM_ID = b.MEETING_ID
	    ORDER BY SWC_TIME ASC
	   ]]>
    </select>
    <select id="selectSTimeInfoBarListKiosk" resultType="TimeInfoVO">
      <![CDATA[
        SELECT TIME_SEQ, SWC_TIME, 
			        CASE  WHEN SWC_TIME > REPLACE(SUBSTRING(CONVERT(VARCHAR(12), GETDATE(), 114), 1,5), ':','') THEN RES_SEQ
			        ELSE -1
			        END AS resSeq,
			        APPRIVAL, USE_YN, SWC_SEQ, SWC_RESDAY
	    FROM tb_swctime
	    WHERE SWC_RESDAY = #{swcResday} AND SWC_SEQ = #{swcSeq} 
	          AND SWC_TIME BETWEEN (SELECT START_TIME FROM TB_SWCINFO) and (SELECT END_TIME FROM TB_SWCINFO)
	    ORDER BY SWC_TIME ASC
	   ]]>
    </select>
    <select id="selectLTimeInfoBarList" resultType="TimeInfoVO">
    <![CDATA[
        
        SELECT d.DATES as SWC_RESDAY,
			       CASE  x.RES_POSSIBLE 
			         WHEN  'O' THEN 'S'
			         WHEN 'F' THEN 'D'
			         ELSE 'W'
			       END AS RES_POSSIBLE,
			       x.SWC_SEQ, 
			       x.SEAT_NAME,
			       x.HOL_DT_YN
		FROM tb_calender  d
		LEFT OUTER JOIN  
		 (SELECT CASE when (SELECT ifnull(count(RES_SEQ),0) FROM tb_swctime e 
		               WHERE a.SWC_RESDAY = e.SWC_RESDAY and  e.SWC_SEQ = a.SWC_SEQ
		                     AND (e.RES_SEQ = 0)  ) 
		               >  17 THEN 'O'
					   ELSE 'F'
			         END AS RES_POSSIBLE,
					 count(TIME_SEQ)as count , 
					 a.SWC_SEQ, b.SEAT_NAME, a.SWC_RESDAY,
					 e.HOL_DT_YN  
		  FROM TB_SWCTIME a, TB_SWC_ROOM b , TB_CENTERINFO c, TB_HOLY e
		  WHERE  a.SWC_SEQ = b.SWC_SEQ AND b.CENTER_ID = c.CENTER_ID  
				      AND b.CENTER_ID = #{centerId} AND b.SWC_SEQ = #{swcSeq}
					  AND a.SWC_RESDAY BETWEEN #{timeStartDay} AND #{timeEndDay}
					  AND e.DT = a.SWC_RESDAY		 				
		  GROUP BY a.SWC_SEQ, b.SEAT_NAME, a.SWC_RESDAY, e.HOL_DT_YN
		 ) x
		 ON d.DATES = x.SWC_RESDAY 
		 WHERE d.DATES BETWEEN #{timeStartDay} AND #{timeEndDay} 
		 ORDER BY d.DATES asc,  x.SEAT_NAME ASC		
	     ]]>
    </select>
    <select id="selectTimeUp" resultType="java.lang.String">
      SELECT dbo.FN_UPSTIMEDOWN(#{endTime}) as endTime
    </select>
    
    
    
    <!--  좌석 화인  -->
    <select id="selectResPreCheckInfo" resultType="java.lang.Integer">
          SELECT  ISNULL(COUNT(*),0) AS CNT
	      FROM TB_SWCTIME
	      WHERE  SWC_RESDAY = #{params.timeStartDay}  AND ITEM_ID = #{params.meetingId} 
	             AND SWC_TIME BETWEEN #{params.strTime} AND #{params.endTime}      
		         AND RES_SEQ != 0       
		         AND USE_YN = 'N'   and  APPRIVAL in ('R','Y','E')
		         <if test="params.resGubun == 'SWC_GUBUN_2' ">
		            AND ITEM_ID IN 
		            <foreach collection="params.meetingSeq" item="item" open="(" close=")" separator=",">
		               #{item}
		            </foreach>
	             </if>
    </select>
    
    <!-- <select id="selectResPreCheckMeetingCount" resultType="java.lang.Integer">
          SELECT  IFNULL(COUNT(*),0)
	      FROM tb_swctime
	      WHERE  SWC_RESDAY = #{timeStartDay}  and swc_time between #{strTime} and #{endTime}      
	      and RES_SEQ != 0       
	      and SWC_SEQ IN 
	      <foreach collection="meetingSeq" item="meetingSeq" open="(" close=")" separator=",">
	          #{meetingSeq}
	      </foreach>
	      and USE_YN = 'N'   and  APPRIVAL in ('R','Y','E')
    </select> -->
    <!--  좌석 화인  끝 -->
    
    
    
    <!--  회의실 장기 예약 -->
    <select id="selectResPreCheckInfoL" resultType="java.lang.Integer">
          SELECT  ISNULL(COUNT(*),0) as CNT
	      FROM TB_SWCTIME
	      WHERE  SWC_RESDAY BETWEEN #{timeStartDay} AND #{timeEndDay}  
	             AND MEETING_ID = #{meetingId} 
	             AND swc_time BETWEEN #{strTime} AND #{endTime}      
				 AND RES_SEQ != 0       
				 AND USE_YN = 'N'   and  APPRIVAL in ('R','Y','E')
    </select>
    
    
    <update id="updateTimeInfo">
        UPDATE tb_swctime SET RES_SEQ = #{params.resSeq} , APPRIVAL =#{params.apprival}
        WHERE ITEM_ID = #{params.meetingId} 
              AND SWC_RESDAY = #{params.timeStartDay} 
              AND SWC_TIME BETWEEN #{params.strTime} AND #{params.endTime}
              <if test="params.resGubun == 'SWC_GUBUN_2' ">
              AND ITEM_ID IN 
	               <foreach collection="params.meetingSeq" item="item" open="(" close=")" separator=",">
		            #{item}
		           </foreach>
              </if>
    </update>
    
    <!-- <update id="updateTimeInfoMeeting">
        UPDATE tb_swctime set RES_SEQ = #{resSeq} , APPRIVAL =#{apprival}
        WHERE  SWC_RESDAY = #{timeStartDay} AND SWC_TIME BETWEEN #{strTime} AND #{endTime}
                    AND SWC_SEQ IN 
	               <foreach collection="meetingSeq" item="meetingSeq" open="(" close=")" separator=",">
		            #{meetingSeq}
		           </foreach>
    </update> -->
    
    <update id="updateTimeInfoY">
        UPDATE tb_swctime SET APPRIVAL =#{apprival}
        WHERE RES_SEQ = #{resSeq}
     </update>

    
    <update id="updateTimeInfoL">
        UPDATE tb_swctime set RES_SEQ = #{resSeq}, APPRIVAL =#{apprival}
        WHERE SWC_SEQ = #{swcSeq} 
              AND SWC_RESDAY BETWEEN #{timeStartDay} AND #{timeEndDay} 
              AND SWC_TIME BETWEEN #{strTime} AND #{endTime}
    </update>
    
    <update id="resTimeReset">
        UPDATE tb_swctime SET RES_SEQ = 0, APPRIVAL =#{apprival}
        WHERE RES_SEQ = #{resSeq}
    </update>
    
    <insert id="inseretTimeCreate">
       { call SP_ROOM_TIMECREATE() }
    </insert>
    
</mapper>